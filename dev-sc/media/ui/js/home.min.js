$(function(){"use strict";var $kapmap,currentDep,clusters={},currentDate=$("button.week-num.current").attr("data-date"),moisList=["Jan","Févr.","Mars","Avr.","Mai","Juin","Juil.","Août","Sep.","Oct.","Nov.","Déc."],weekMS=6048e5;window.buildMap=function(id,latlng){var opt={disableDefaultUI:false,polyStyle:{fillColor:"red",fillOpacity:.5,strokeWeight:1,strokeColor:"#444",clickable:false,editable:false,zIndex:1}};if(latlng&&latlng.lat&&latlng.lng){opt.center={lat:latlng.lat,lng:latlng.lng,zoom:10}}if(!$("#"+id).length||!$.fn.kapmap)return;$("#"+id).kapmap(opt);$kapmap=$("#"+id).data("kapmap");enableClusterers();$("#dep-select").on("change",function(){currentDep=$(this).children("option:selected").val();$.ajax({url:"/map/departement",data:{dep:currentDep},dataType:"json"}).done(function(d){$kapmap.clearPolygons();var poly=$kapmap.loadPolygon(d);$kapmap.setMapCenter(poly.getBounds().getCenter(),8);var manif=getManifestations(getSelectedCategories(),getSelectedDep());manif.done(function(d){injectManifestations(d,true)})})});getManifestations(null,0).done(function(d){injectManifestations(d,true)});$("#categories input[data-cat]").on("click",function(){var manif=getManifestations(getSelectedCategories(),getSelectedDep());manif.done(function(d){injectManifestations(d,true)})})};function isMapLoading(loading){if(loading){$("#homeload").css("opacity",1)}else{$("#homeload").css("opacity",0)}}function getSelectedDep(){return $("#dep-select").children("option:selected").val()||0}function getSelectedCategories(){var selected=new Array;$("#categories input[data-cat]:checked").each(function(){selected.push($(this).attr("data-cat"))});return selected}function injectManifestations(data,reset){if(reset){$kapmap.clearMarkers();clearClusterers()}for(var i=0;i<data.length;i++){if(!data[i].gps)continue;var marker,icon;switch(data[i].type){case"auto":icon="/media/ui/img/map/marker-red.png";break;case"moto":icon="/media/ui/img/map/marker-blue.png";break;case"collection":icon="/media/ui/img/map/marker-yellow.png";break;default:icon="/media/ui/img/map/marker-red.png"}marker=$kapmap.displayCustomMarker(data[i].gps,icon,$kapmap.getInfoWindow('<p class="infotitle">'+data[i].name+"</p>"+'<a href="'+data[i].link+'">En savoir +</a>'));marker._kapdata=data[i];marker.on("click",function(){$kapmap.closeInfoWindows();this._kapinfo.open($kapmap.map,this)});var checkok=true;var poly=$kapmap.getLastPolygon();if(poly&&poly.constructor===google.maps.Polygon){var bounds=poly.getBounds();if(!bounds.contains(marker.getPosition())){marker.setMap(null);checkok=false;console.warn("-- BOUNDS CHECK FAILED FOR ",marker._kapdata._id);$.ajax({url:"/map/fail",data:{_id:marker._kapdata._id}})}}if(checkok)clusters[marker._kapdata.type].addMarker(marker)}isMapLoading(false)}function getManifestations(type,dep){isMapLoading(true);var data={dep:dep,date:currentDate};if(type&&type.length)data.category=type.join(",");return $.ajax({url:"/map/manifestation",dataType:"json",data:data})}function clearClusterers(){clusters.moto.clearMarkers();clusters.auto.clearMarkers();clusters.collection.clearMarkers()}function enableClusterers(){clusters.moto={gridSize:50,styles:[{textColor:"white",url:"/media/ui/img/map/cluster-blue.png",height:33,width:33},{textColor:"white",url:"/media/ui/img/map/cluster-blue.png",height:33,width:33},{textColor:"white",url:"/media/ui/img/map/cluster-blue.png",height:33,width:33}]};clusters.auto={gridSize:50,styles:[{textColor:"white",url:"/media/ui/img/map/cluster-red.png",height:33,width:33},{textColor:"white",url:"/media/ui/img/map/cluster-red.png",height:33,width:33},{textColor:"white",url:"/media/ui/img/map/cluster-red.png",height:33,width:33}]};clusters.collection={gridSize:50,styles:[{textColor:"white",url:"/media/ui/img/map/cluster-yellow.png",height:33,width:33},{textColor:"white",url:"/media/ui/img/map/cluster-yellow.png",height:33,width:33},{textColor:"white",url:"/media/ui/img/map/cluster-yellow.png",height:33,width:33}]};clusters.moto=new MarkerClusterer($kapmap.map,[],clusters.moto);clusters.auto=new MarkerClusterer($kapmap.map,[],clusters.auto);clusters.collection=new MarkerClusterer($kapmap.map,[],clusters.collection)}$(".allAuto").click(function(){categoryCheck("auto")});$(".allMoto").click(function(){categoryCheck("moto")});$(".allCollection").click(function(){categoryCheck("collection")});$("#btnHome").click(function(){if(!$kapmap)return false;if(navigator.geolocation){isMapLoading(true);navigator.geolocation.getCurrentPosition(function(pos){isMapLoading(false);var latlng=new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude);$kapmap.setMapCenter(latlng,8);$kapmap.displayCustomMarker(latlng,"/media/ui/img/map/marker-home.png")},function(err){isMapLoading(false);console.error("Could not determine geoposition",err)})}else{alert("Désolé, votre navigateur ne permet pas de vous géolocalisaer")}});$("#previousWeek").click(function(){previousWeek();updateWeekUI();autoClick()});$("#nextWeek").click(function(){nextWeek();updateWeekUI();autoClick()});$("#weekPicker").change(function(){setWeekFromDate($(this).val())});$(".week-num").click(function(){setWeekFromDate($(this).attr("data-date"))});function autoClick(){var manif=getManifestations(getSelectedCategories(),getSelectedDep());manif.done(function(d){injectManifestations(d,true)})}function categoryUncheck(){$('#categories input[type="checkbox"]').prop("checked",false)}function categoryCheck(cat){var boxes=$(".is-"+cat+' input[type="checkbox"]');if(!boxes.length&&boxes.length>0)return false;var v=!boxes.eq(0).prop("checked")==true;boxes.prop("checked",v);autoClick()}function setWeekFromDate(date){currentDate=date;updateWeekUI();autoClick()}function updateWeekUI(){var datesButtons=$("#dates-buttons"),delta=datesButtons.attr("data-delta"),last=$("#previousWeek"),diff=weekDiff(),before,after,item;before=2;if(diff>=0&&diff<=2)before=diff;after=delta-1-before;$(".week-num").remove();for(var i=before;i>0;i--){item=weekItem(i*-1);item.insertAfter(last);last=item}item=weekItem(0,true);item.insertAfter(last);last=item;for(var i=1;i<=after;i++){item=weekItem(i);item.insertAfter(last);last=item}var num=getWeekNumber(currentDate),sel='#weekPicker option[data-week="'+num+'"]';$(sel).attr("selected","selected")}function weekItem(week,sel){sel=sel||false;var date=new Date(currentDate),timestamp=date.getTime()+7*86400*1e3*week,itemDate=new Date(timestamp),num=getWeekNumber(itemDate),css=sel?"current":"";var year=itemDate.getFullYear(),month=itemDate.getMonth()+1,day=itemDate.getDate(),mois=moisList[month-1],btn;if(month<10)month="0"+month;if(day<10)day="0"+day;if(num<10)num="0"+num;btn=$('<button class="btn week-num '+css+'" data-date="'+year+"/"+month+"/"+day+'">'+day+" "+mois+"</button>");btn.click(function(){setWeekFromDate($(this).attr("data-date"))});return btn}function getWeekNumber(d){d=new Date(d);d.setHours(0,0,0);d.setDate(d.getDate()+4-(d.getDay()||7));var yearStart=new Date(d.getFullYear(),0,1);var weekNo=Math.ceil(((d-yearStart)/864e5+1)/7);return weekNo}function weekDiff(){var tmp=new Date,now=new Date(tmp.getFullYear()+"/"+(tmp.getMonth()+1)+"/"+tmp.getDate()),cur=new Date(currentDate),diff=now.getTime()-cur.getTime();var result=Math.round(diff/weekMS)*-1;return result}function previousWeek(){var now=new Date,date=new Date(currentDate),prev=new Date(date.getTime()-weekMS);if(prev.getTime()<now.getTime())prev=now;currentDate=dateFormat(prev)}function nextWeek(){var date=new Date(currentDate),next=new Date(date.getTime()+weekMS);currentDate=dateFormat(next)}function dateFormat(d){var string=d.getFullYear()+"/";string+=(d.getMonth()<9?"0"+(d.getMonth()+1):d.getMonth()+1)+"/";string+=d.getDate();return string}if(!Modernizr.touch)buildMap("map")});
//# sourceMappingURL=home.js.map