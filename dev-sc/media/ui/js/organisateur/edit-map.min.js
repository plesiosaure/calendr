var KAPMap={mapOptions:{},map:{},geocoder:{},selectors:{markerPanel:"#chateau",markerSave:"#savemarker",markerTitle:"#title"},init:function(){this.setMapOptions();this.map=new google.maps.Map(document.getElementById("map"),this.mapOptions);this.geocoder=new google.maps.Geocoder;DrawingManager.init();DrawingManager.setMap(this.map);var lat=$('input[name="lat"]').val().replace(",",".");var lng=$('input[name="lng"]').val().replace(",",".");if(lat!=""&&lng!=""){var geoloc=new google.maps.LatLng(lat,lng);this.setAddressMarker(geoloc);this.setLocation(geoloc);this.map.setCenter(geoloc)}var zoom=$('input[name="zoom"]').val();if(parseInt(zoom)>0)this.setZoom(zoom)},getGeoCode:function(address,callback){var that=this;this.geocoder.geocode({address:address},function(results,status){if(status==google.maps.GeocoderStatus.OK){that.map.setCenter(results[0].geometry.location);that.setLocation(results[0].geometry.location);that[callback](results[0].geometry.location)}else{alert("Impossible de géolocaliser cette adresse")}})},setMapAddress:function(){var zip=$('input[name="zip"]').val(),city=$("#city-search").val(),pays=$('input[name="pays"]').val();if(!zip||!city){alert("Vous devez remplir une adresse complète avant de la localiser sur la carte");return}this.getGeoCode(zip+" "+city,"setAddressMarker")},setAddressMarker:function(geoloc){var that=this;var marker=new google.maps.Marker({position:geoloc,map:that.map,title:"M"});DrawingManager.clearStore();DrawingManager.addPoly(marker,"marker")},setZoom:function(zoom){this.map.setOptions({zoom:parseInt(zoom)})},showMarkerPanel:function(show){if(show){$(this.selectors.markerPanel).show();$(this.selectors.markerPanel).stop().animate({height:"220px"},118);$(this.selectors.markerSave).on("click",$.proxy(function(){DrawingManager.addInfoWindow({title:$(this.selectors.markerTitle).val(),info:tinyMCE.activeEditor.getContent()})},this))}else{$(this.selectors.markerPanel).stop().animate({height:"0px"},118,function(){$(this).hide()})}},setLocation:function(location){this.location=location},setMapOptions:function(){var coords=new google.maps.LatLng(46.649436,2.557751);this.mapOptions={center:coords,zoom:5,mapTypeId:google.maps.MapTypeId.ROADMAP};this.setLocation(coords)},saveMap:function(){var build=[];var region="none";for(var i in DrawingManager.store){var poly={};poly.location={};poly.color=DrawingManager.store[i].fillColor;poly.kapType=DrawingManager.store[i].kapType;if(DrawingManager.store[i].kapType=="poly"&&myType!=78){var path=DrawingManager.store[i].getPath();poly.location.lat=path.getAt(0).lat();poly.location.lng=path.getAt(0).lng();poly.zoom=this.map.zoom;poly.id=myID;build.push(poly)}}build=JSON.stringify(build);region=JSON.stringify(region);$.ajax({url:"data",type:"POST",data:{build:build,id:myID,type:myType,region:region}}).done($.proxy(function(d){$("#saved").fadeTo(218,1)},this))},loadMap:function(data){var mapOpt=this.getLoadOptions();for(var i=0;i<data.length;i++){var kapID=Math.floor(Math.random()*999999);var poly=$.extend({},{fillColor:data[i].color,fillOpacity:.5,strokeWeight:1,strokeColor:"#444",clickable:true,editable:true,zIndex:1},mapOpt.polyOpt);if(data[i].kapType=="poly"){poly.paths=google.maps.geometry.encoding.decodePath(data[i].path);_polygon=new google.maps.Polygon(poly);_polygon.kapID=kapID;_polygon.id_content=data[i].id_content;DrawingManager.addPoly(_polygon,data[i].kapType)}else if(data[i].kapType=="marker"){poly.title=data[i].title;poly.clickable=true;poly.position=new google.maps.LatLng(data[i].location.lat,data[i].location.lng);_polygon=new google.maps.Marker(poly);_polygon.kapID=kapID;DrawingManager.addPoly(_polygon,data[i].kapType);DrawingManager.addInfoWindow({title:data[i].title,info:data[i].content})}_polygon.setMap(this.map)}if(typeof savedLocation!=="undefined"){var coords=new google.maps.LatLng(savedLocation.lat,savedLocation.lng);this.setZoom(savedLocation.zoom);this.setLocation(coords);this.map.setCenter(coords)}else{var coords=new google.maps.LatLng(data[0].location.lat,data[0].location.lng);if(typeof data[0].zoom!=="undefined"){this.setZoom(data[0].zoom)}this.setLocation(coords);this.map.setCenter(coords)}},getLoadOptions:function(){}};var DrawingManager={manager:{},selectedShape:false,store:{},polyOpt:{fillColor:"#000",fillOpacity:.5,strokeWeight:1,strokeColor:"#444",clickable:true,editable:true,zIndex:1},init:function(){this.manager=new google.maps.drawing.DrawingManager({drawingMode:this.setDefaultDrawingMode(),drawingControl:true,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:this.setDrawingMode()},markerOptions:{},polygonOptions:this.polyOpt,rectangleOptions:this.polyOpt});this.bindDrawEvents()},setDrawingMode:function(){return[google.maps.drawing.OverlayType.MARKER]},setDefaultDrawingMode:function(){return google.maps.drawing.OverlayType.MARKER},bindDrawEvents:function(){var that=this;google.maps.event.addListener(that.manager,"overlaycomplete",function(e){if(e.type!=google.maps.drawing.OverlayType.MARKER){var newShape=e.overlay;that.addPoly(newShape,"poly")}if(e.type==google.maps.drawing.OverlayType.MARKER){var newShape=e.overlay;that.clearStore();that.addPoly(newShape,"marker");KAPMap.showMarkerPanel(true)}});google.maps.event.addListener(that.manager,"drawingmode_changed",function(){that.clearSelection()});google.maps.event.addListener(KAPMap.map,"click",function(){that.clearSelection()});google.maps.event.addListener(KAPMap.map,"zoom_changed",this.saveZoom);google.maps.event.addDomListener(document.getElementById("set-map-adress"),"click",function(){KAPMap.setMapAddress()})},addPoly:function(poly,type){var that=this;var kapID=Math.floor(Math.random()*999999);poly.kapID=kapID;poly.kapType=type;this.store[kapID]=poly;this.manager.setDrawingMode(null);google.maps.event.addListener(poly,"click",function(){that.setSelection(poly)});google.maps.event.addListener(poly,"rightclick",function(e){that.deleteVertex(e)});this.updateFormGeoloc(this.store[kapID].getPosition())},updateFormGeoloc:function(data){$('input[name="lat"]').val(data.lat());$('input[name="lng"]').val(data.lng())},clearStore:function(){for(var i in this.store){this.store[i].setMap(null);delete this.store[i]}},deleteVertex:function(mev){if(mev.vertex!=null){this.selectedShape.getPath().removeAt(mev.vertex)}},setSelection:function(shape){this.clearSelection();this.selectedShape=shape;if(shape.kapType!="marker"){shape.setEditable(true)}else if(shape.kapType=="marker"){KAPMap.showMarkerPanel(true)}},clearSelection:function(){if(typeof this.selectedShape==="object"){if(this.selectedShape.kapType!="marker"){this.selectedShape.setEditable(false)}else if(this.selectedShape.kapType=="marker"){KAPMap.showMarkerPanel(false)}this.selectedShape=false}},deleteSelectedShape:function(){if(typeof this.selectedShape==="object"){this.selectedShape.setMap(null);delete this.store[this.selectedShape.kapID]}},setFillColor:function(color){var optPoly=this.manager.get("polygonOptions");optPoly.fillColor=color;var optRect=this.manager.get("rectangleOptions");optRect.fillColor=color;this.manager.set("rectangleOptions",optRect);this.manager.set("polygonOptions",optPoly);if(typeof this.selectedShape==="object"){this.selectedShape.setOptions({fillColor:color})}},addInfoWindow:function(opt){this.selectedShape.setOptions({title:opt.title});this.selectedShape.kapInfo=new google.maps.InfoWindow({content:opt.info});google.maps.event.addListener(this.selectedShape,"click",$.proxy(function(){this.selectedShape.kapInfo.open(KAPMap.map,this.selectedShape);tinyMCE.activeEditor.setContent(this.selectedShape.kapInfo.content);$(KAPMap.selectors.markerTitle).val(this.selectedShape.title)},this))},setMap:function(map){this.manager.setMap(map)},saveZoom:function(){$('input[name="zoom"]').val(KAPMap.map.zoom)}};$(function(){KAPMap.init()});
//# sourceMappingURL=edit-map.js.map